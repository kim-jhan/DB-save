​

using MySql.Data.MySqlClient;

using System.IO;

​

namespace Day014_1_영상처리__Bata_4__GUI2

{

public partial class Form1 : Form

{

public static byte[,] dbImage;

public static int return_i_id;

int openValue; // 0 DB로 오픈 1 일반 오픈

​

public Form1()

{

InitializeComponent();

}

​

//전역 함수부

static byte[,] inImage, outImage;

static int inH, inW, outH, outW;

static string filename;

static Bitmap paper; //그림을 찍을 종이

String connStr = "Server=192.168.56.103;Uid=win2653;Pwd=4321;Database=image_db;Charset=UTF8";

MySqlConnection conn; // 교량

MySqlCommand cmd; // 트럭

String sql = ""; // 물건박스

MySqlDataReader reader; // 트럭이 가져올 끈

​

bool mouseYN = false;

int sx, sy, ex, ey;

​

private void 파일불러오기ToolStripMenuItem_Click(object sender, EventArgs e)

{

openValue = 0;

Formfilefullname odb = new Formfilefullname();

odb.ShowDialog();

inW = dbImage.GetLength(0);

inH = dbImage.GetLength(1);

inImage = new byte[inH, inW]; // 메모리 할당

for (int i = 0; i < inH; i++)

{

for (int j = 0; j < inW; j++)

{

inImage[i, j] = dbImage[i, j];

}

}

equal_image();

}

​

private void 저장ToolStripMenuItem1_Click(object sender, EventArgs e)

{

// c:\\images\\pet_raw\\cat256_01.raw

String i_fname = "", i_extname = "";

long i_fsize = 0;

int i_width = 0, i_height = 0;

if (openValue == 1)

{

String[] tmp = filename.Split('\\');

String tmp1 = tmp[tmp.Length - 1]; // cat256_01.raw

String[] tmp2 = tmp1.Split('.');

i_fname = tmp2[0]; //cat256_01

i_extname = tmp2[1]; //raw

i_fsize = new FileInfo(filename).Length;

i_width = (int)Math.Sqrt(i_fsize);

i_height = i_width;

}

else

{

sql = "SELECT i_fname, i_extname, i_fsize, i_width, i_height FROM image WHERE i_id = " + return_i_id; // 짐 싸기

cmd.CommandText = sql; // 짐을 트럭에 싣기

reader = cmd.ExecuteReader(); // 짐을 서버에 부어넣고, 끈으로 묶어서 끈만 가져옴.

while (reader.Read())

{

i_fname = (String)reader["i_fname"];

i_extname = (String)reader["i_extname"];

i_fsize = (long)reader["i_fsize"];

i_width = (int)reader["i_width"];

i_height = (int)reader["i_height"];

}

reader.Close();

}

String i_user = "Hong";

Random rnd = new Random();

int i_id = rnd.Next(0, int.MaxValue);

// 이미지 테이블(부모 테이블)에 INSERT

sql = "INSERT INTO image(i_id, i_fname, i_extname, i_fsize, i_width, i_height, i_user) VALUES (";

sql += i_id + ", '" + i_fname + "', '" + i_extname + "', " + i_fsize + ", ";

sql += i_width + ", " + i_height + ", '" + i_user + "')";

cmd = new MySqlCommand("", conn);

cmd.CommandText = sql; // 짐을 트럭에 싣기

cmd.ExecuteNonQuery();

//RAW 파일을 열어서 pixel 테이블에 INSERT

int p_row, p_col, p_value;

cmd = new MySqlCommand("", conn);

for (int i = 0; i < i_width; i++)

{

for (int k = 0; k < i_height; k++)

{

p_row = i;

p_col = k;

p_value = (int)outImage[i, k];

sql = "INSERT INTO pixel(i_id, p_row, p_col, p_value) VALUES(";

sql += i_id + ", " + p_row + ", " + p_col + ", " + p_value + ")";

cmd.CommandText = sql;

cmd.ExecuteNonQuery();

}

}

MessageBox.Show(filename + "입력 완료");

}

​

DB 불러오기 폼

​

using System;

using System.Collections.Generic;

using System.ComponentModel;

using System.Data;

using System.Drawing;

using System.Linq;

using System.Text;

using System.Threading.Tasks;

using System.Windows.Forms;

using MySql.Data.MySqlClient;

using System.IO;

​

namespace Day014_1_영상처리__Bata_4__GUI2

{

public partial class Formfilefullname : Form

{

String connStr = "Server=192.168.56.103;Uid=win2653;Pwd=4321;Database=image_db;Charset=UTF8";

MySqlConnection conn; // 교량

MySqlCommand cmd; // 트럭

String sql = ""; // 물건박스

MySqlDataReader reader; // 트럭이 가져올 끈

private static object text;

​

public Formfilefullname()

{

InitializeComponent();

}

​

private void Formfilefullname_Load(object sender, EventArgs e)

{

conn = new MySqlConnection(connStr);

conn.Open();

cmd = new MySqlCommand("", conn);

sql = "SELECT i_id, i_fname, i_extname, i_width, i_height FROM image"; // 짐 싸기

cmd.CommandText = sql; // 짐을 트럭에 싣기

reader = cmd.ExecuteReader(); // 짐을 서버에 부어넣고, 끈으로 묶어서 끈만 가져옴.

int i_id, i_width, i_height;

String i_fname, i_extname; // 톡!하고 땡겨올 짐을 담을 변수.

String[] file_list = { };

// 끈을 톡!하고 당기기

while (reader.Read())

{

i_id = (int)reader["i_id"];

i_fname = (String)reader["i_fname"];

i_extname = (String)reader["i_extname"];

i_width = (int)reader["i_width"];

i_height = (int)reader["i_height"];

String str = i_id + "/" + i_fname + "." + i_extname + "/" + i_width + "x" + i_height;

Array.Resize(ref file_list, file_list.Length + 1); //배열크기 한개 증가

file_list[file_list.Length - 1] = str;

}

reader.Close();

comboBox1.Items.Clear();

comboBox1.Items.AddRange(file_list);

}

​

private void Formfilefullname_FormClosed(object sender, FormClosedEventArgs e)

{

conn.Close();

}

​

private void comboBox1_SelectedIndexChanged(object sender, EventArgs e)

{

String selectStr = comboBox1.SelectedItem.ToString();

int i_id = int.Parse(selectStr.Split('/')[0]);

Form1.return_i_id = i_id;

int i_width = int.Parse(selectStr.Split('/')[2].Split('x')[0]);

int i_height = int.Parse(selectStr.Split('/')[2].Split('x')[1]);

sql = "SELECT p_row, p_col, p_value FROM pixel WHERE i_id = " + i_id; // 짐 싸기

cmd.CommandText = sql; // 짐을 트럭에 싣기

reader = cmd.ExecuteReader(); // 짐을 서버에 부어넣고, 끈으로 묶어서 끈만 가져옴.

int row, col;

Form1.dbImage = new byte[i_width, i_height];

while (reader.Read())

{

row = int.Parse(reader["p_row"].ToString());

col = int.Parse(reader["p_col"].ToString());

Form1.dbImage[row, col] = (byte)(int.Parse(reader["p_value"].ToString()));

}

reader.Close();

this.Close();

}

​

private void button3_Click(object sender, EventArgs e)

{

// <3> 물건을 준비해서, 트럭에 실어서 다리 건너 부어넣기.

sql = "SELECT i_id, i_fname, i_extname, i_width, i_height FROM image"; // 짐 싸기

cmd.CommandText = sql; // 짐을 트럭에 싣기

reader = cmd.ExecuteReader(); // 짐을 서버에 부어넣고, 끈으로 묶어서 끈만 가져옴.

int i_id, i_width, i_height;

String i_fname, i_extname; // 톡!하고 땡겨올 짐을 담을 변수.

// 끈을 톡!하고 당기기

String[] file_list = { };

while (reader.Read())

{

i_id = (int)reader["i_id"];

i_fname = (String)reader["i_fname"];

i_extname = (String)reader["i_extname"];

i_width = (int)reader["i_width"];

i_height = (int)reader["i_width"];

String str = i_id + "/" + i_fname + "." + i_extname;

str += "/" + i_width + "x" + i_height;

Array.Resize(ref file_list, file_list.Length + 1); // 배열크기 1개 증가.

file_list[file_list.Length - 1] = str;

}

reader.Close();

comboBox1.Items.AddRange(file_list);

}

​

private void button1_Click_1(object sender, EventArgs e)

{

/*

CREATE TABLE image (

i_id INT NOT NULL PRIMARY KEY, -- 아이디. 랜덤하게 생성.

i_fname VARCHAR(50) NOT NULL, -- 파일명

i_extname VARCHAR(10) NOT NULL, -- 확장명

i_fsize BIGINT NOT NULL, -- 파일 크기

i_width INT NOT NULL, -- 이미지 폭

i_height INT NOT NULL, -- 이미지 높이

i_user VARCHAR(20) -- 이미지 업로드 유저

);

*/

String full_name = Formfilefullname.text.ToString();

// c:\\images\\pet_raw\\cat256_01.raw

String[] tmp = full_name.Split('\\');

String tmp1 = tmp[tmp.Length - 1]; // cat256_01.raw

String[] tmp2 = tmp1.Split('.');

String i_fname = tmp2[0]; // cat256_01

String i_extname = tmp2[1]; // raw

long i_fsize = new FileInfo(full_name).Length;

int i_width = (int)Math.Sqrt(i_fsize);

int i_height = i_width;

String i_user = "Hong";

Random rnd = new Random();

int i_id = rnd.Next(int.MinValue, int.MaxValue);

// 이미지 테이블(부모 테이블)에 Insert

// <3> 물건을 준비해서, 트럭에 실어서 다리 건너 부어넣기.

sql = "INSERT INTO image(i_id, i_fname, i_extname, i_fsize, i_width, ";

sql += "i_height,i_user ) VALUES (";

sql += i_id + ", '" + i_fname + "', '" + i_extname + "', " + i_fsize + ",";

sql += i_width + "," + i_height + ",'" + i_user + "')";

​

//textBox1.Text = sql;

cmd.CommandText = sql; // 짐을 트럭에 싣기

cmd.ExecuteNonQuery();

​

// RAW 파일을 열어서 pixel 테이블에 Insert...

/*

CREATE TABLE pixel (

i_id INT NOT NULL, -- 이미지 파일 아이디 (FK)

p_row INT NOT NULL, -- 행 위치

p_col INT NOT NULL, -- 열 위치

p_value TINYINT UNSIGNED NOT NULL, -- 픽셀값

FOREIGN KEY (i_id) REFERENCES image(i_id) 

);

*/

int p_row, p_col, p_value;

BinaryReader br = new BinaryReader(File.Open(full_name, FileMode.Open));

cmd = new MySqlCommand("", conn);

for (int i = 0; i < i_width; i++)

for (int k = 0; k < i_height; k++)

{

p_row = i; p_col = k;

p_value = (int)br.ReadByte();

sql = "INSERT INTO pixel(i_id, p_row, p_col, p_value) VALUES(";

sql += i_id + "," + p_row + "," + p_col + "," + p_value + ")";

cmd.CommandText = sql; // 짐을 트럭에 싣기

cmd.ExecuteNonQuery();

}

br.Close();

MessageBox.Show(full_name + " 입력 완료!");

}
